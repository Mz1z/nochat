<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>websocket</title>
 </head>
 <body>
 	用户名: <input id="uname" type="text" value="Mz1"><br>
 	密码: <input id="passwd" type="text" value="123456"><br>
 	<input type="submit" value="connect" onclick="connect_to_server()"><br>
 	<hr/>
 <input id="text" value="">
 
 <input type="submit" value="send" onclick="send()">
 <input type="submit" value="close" onclick="close()">
<div id="msg"></div>
 <script>
 /**
 0：未连接

1：连接成功，可通讯

2：正在关闭

3：连接已关闭或无法打开
*/
	var webSocket;   // 全局变量
	function connect_to_server(){
		//创建一个webSocket 实例
	    var _url = "ws://127.0.0.1:2333";
	    webSocket = new WebSocket(_url);

	    webSocket.onerror = function (event){
	        onError(event);
	    };
	    // 打开websocket
	    webSocket.onopen = function (event){
	        onOpen(event);
	    };
	    //监听消息
	    webSocket.onmessage = function (event){
	        onMessage(event);
	    };
	    webSocket.onclose = function (event){
	        onClose(event);
	    }
	}    

    //关闭监听websocket
    function onError(event){
        document.getElementById("msg").innerHTML = "<p>close</p>";
        console.log("error"+event.data);
    };

    function onOpen(event){
        console.log("open:"+sockState());
        //console.log(webSocket);
        document.getElementById("msg").innerHTML = "<p>Connect to Service</p>";
        document.getElementById("msg").innerHTML += '<p>连接到: '+webSocket.url+'</p>';
        // 发送登录包
        var _pack = {};
        _pack.cmd = 1; //登录包
        _pack.data = {};
        _pack.data.uname = document.getElementById("uname").value;
        _pack.data.passwd = document.getElementById("passwd").value;
        console.log(_pack);
        webSocket.send(JSON.stringify(_pack));
    };
    function onMessage(event){
        console.log("onMessage");
        document.getElementById("msg").innerHTML += "<p>response: "+event.data+"</p>"
    };

    function onClose(event){
        document.getElementById("msg").innerHTML = "<p>close</p>";
        console.log("close: "+sockState());
        webSocket.close();
    }

    function sockState(){
        var status = ['未连接','连接成功，可通讯','正在关闭','连接已关闭或无法打开'];
            return status[webSocket.readyState];
    }



 	function send(event){
        console.log(webSocket);
        var msg = document.getElementById('text').value;
        document.getElementById('text').value = '';
        console.log("send:"+sockState());
        console.log(msg);
        webSocket.send(msg);
        document.getElementById("msg").innerHTML += "<p>request: "+msg+"</p>"
    };

    function close(event){
        webSocket.close();
    }
 </script>
 </body>
</html>